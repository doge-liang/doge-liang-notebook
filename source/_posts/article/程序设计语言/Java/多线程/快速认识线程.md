---
title: 快速认识线程
date: 2022-07-28
tags: []
categories:

  - 程序设计语言
  - Java
  - 多线程
---

## 快速认识线程

现代操作系统几乎都支持多任务，对计算机来说每个任务就是一个进程（Process），每个进程中必须要有一个线程（Thread）是在运行中的，有时线程也称为轻量级的进程。每个线程都有自己的局部变量表、程序计数器以及生命周期等。

### 快速创建一个线程

```JAVA
public static void main(String[] args) {
    //通过匿名内部类的方式创建线程，并且重写其中的run方法
    new Thread() {         //①
        @Override
        public void run() {
            enjoyMusic();
        }
    }.start();           //②
    browseNews();
}
```

创建线程必须要两步：

1. 创建一个 `Thread` 实例，并重写其 `run` 方法；
2. 调用其 `start()` 方法，该方法不会阻塞主线程；

程序启动后我们可以使用 `jstack` 工具查看线程快照，线程快照中包含每个线程瞬时的方法调用栈，当程序死锁是可以使用该工具分析线程死锁的原因；
对以上程序我们会看到不止两个线程： `Thread-0` 是我们启动的线程， `main` 是主线程。另外还有一些守护线程，比如垃圾回收线程、 RMI 线程等。

### 线程的生命周期

![picture 7](../../../../../assets/%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1%E8%AF%AD%E8%A8%80/Java/%E5%A4%9A%E7%BA%BF%E7%A8%8B/%E5%BF%AB%E9%80%9F%E8%AE%A4%E8%AF%86%E7%BA%BF%E7%A8%8B/ac9ce161217ecb048e6b183f8a2217bf22eac0027f3f3f7f356aec4f9fc04932.png)  

线程的生命周期大致分为五个阶段：

- NEW：没有调用 `start()` 方法启动该线程，那么线程的状态为 NEW 状态；
- RUNNABLE：NEW 状态通过 `start()` 方法进入 RUNNABLE 状态，这个状态说明线程具备执行的资格，但是并没有真正地执行起来而是在等待 CPU 的调度；
- RUNNING：一旦 CPU 通过轮询或者其他方式从任务可执行队列中选中了线程，此时它才能真正地执行自己的逻辑代码，进入 RUNNING 状态。该状态的线程有三种去向：
  - 直接进入 TERMINATED 状态，比如调用 JDK 已经不推荐使用的 `stop()` 方法或者判断某个逻辑标识；
  - 进入 BLOCKED 状态，比如调用了 `sleep()` ，或者 `wait()` 方法而加入了 `waitSet` 中；
  - 进行某个阻塞的 IO 操作，比如因网络数据的读写而进入了 BLOCKED 状态；
  - 获取某个锁资源，从而加入到该锁的阻塞队列中而进入了BLOCKED状态；
  - 由于 CPU 的调度器轮询使该线程放弃执行，进入 RUNNABLE 状态；
  - 线程主动调用 `yield()` 方法，放弃 CPU 执行权，进入 RUNNABLE 状态。
- BLOCKED：BLOCKED 即阻塞状态，进入阻塞状态的方法如上述。线程在BLOCKED状态中可以切换至如下几个状态：
  - 直接进入 TERMINATED 状态，比如调用 JDK 已经不推荐使用的 `stop()` 方法或者意外死亡（JVM Crash）；
  - 线程阻塞的操作结束，比如读取了想要的数据字节进入到 RUNNABLE 状态；
  - 线程完成了指定时间的休眠，进入到了 RUNNABLE 状态；
  - Wait 中的线程被其他线程 `notify()`/`notifyall()` 唤醒，进入RUNNABLE状态；
  - 线程获取到了某个锁资源，进入 RUNNABLE 状态；
  - 线程在阻塞过程中被打断，比如其他线程调用了 `interrupt()` 方法，进入 RUNNABLE 状态
- TERMINATED：TERMINATED 是一个线程的最终状态，在该状态中线程将不会切换到其他任何状态，线程进入 TERMINATED 状态，意味着该线程的整个生命周期都结束了；
  - 线程运行正常结束，结束生命周期；
  - 线程运行出错意外结束；
  - JVM Crash，导致所有的线程都结束；
