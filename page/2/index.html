<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha256-dABdfBfUoC8vJUBOwGVdm8L9qlMWaHTIfXt+7GnZCIo=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Muse","darkmode":true,"version":"8.22.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/page/2/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://example.com/page/2/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"en","comments":"","permalink":"","path":"page/2/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Hexo</title>
  







<link 
  rel="stylesheet" 
  href="https://cdn.jsdelivr.net/npm/katex@0.16.21/dist/katex.min.css"
>
  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Hexo</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">John Doe</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">204</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">78</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">77</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/07/18/article/%E8%AE%A1%E7%AE%97%E6%9C%BA/%E5%AE%89%E5%85%A8/%E6%9D%82/%E7%AD%BE%E5%90%8D%E5%92%8C%E5%8A%A0%E5%AF%86%E9%A1%BA%E5%BA%8F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/07/18/article/%E8%AE%A1%E7%AE%97%E6%9C%BA/%E5%AE%89%E5%85%A8/%E6%9D%82/%E7%AD%BE%E5%90%8D%E5%92%8C%E5%8A%A0%E5%AF%86%E9%A1%BA%E5%BA%8F/" class="post-title-link" itemprop="url">签名和加密顺序</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-07-18 00:00:00" itemprop="dateCreated datePublished" datetime="2022-07-18T00:00:00+08:00">2022-07-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-02-01 01:22:05" itemprop="dateModified" datetime="2025-02-01T01:22:05+08:00">2025-02-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/article/" itemprop="url" rel="index"><span itemprop="name">article</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/article/%E8%AE%A1%E7%AE%97%E6%9C%BA/" itemprop="url" rel="index"><span itemprop="name">计算机</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/article/%E8%AE%A1%E7%AE%97%E6%9C%BA/%E5%AE%89%E5%85%A8/" itemprop="url" rel="index"><span itemprop="name">安全</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/article/%E8%AE%A1%E7%AE%97%E6%9C%BA/%E5%AE%89%E5%85%A8/%E6%9D%82/" itemprop="url" rel="index"><span itemprop="name">杂</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="签名和加密顺序">签名和加密顺序</h2>
<p>先签名后加密，接收方只能知道消息是由签名者发送的，但消息的创建者并不一定是签名者。如果消息在中途被截获，替换成截获者的签名，存在中间人攻击的风险。如果使用先签名后加密的方案，则能够规避这种风险。</p>
<p>先签名后加密的通信过程一般如下：</p>
<ol>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal">A</span></span></span></span> 使用 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal">A</span></span></span></span> 的私钥 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mi>r</mi><mi>i</mi><msub><mi>K</mi><mi>A</mi></msub></mrow><annotation encoding="application/x-tex">PriK_A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">i</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">A</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 对明文消息 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi></mrow><annotation encoding="application/x-tex">M</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span></span></span></span> 进行签名 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>M</mi><mi>A</mi></msub></mrow><annotation encoding="application/x-tex">M_A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.109em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">A</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>；</li>
<li>然后使用 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi></mrow><annotation encoding="application/x-tex">B</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span> 的公钥 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mi>u</mi><mi>b</mi><msub><mi>K</mi><mi>B</mi></msub></mrow><annotation encoding="application/x-tex">PubK_B</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord mathnormal">u</span><span class="mord mathnormal">b</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 对消息 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi></mrow><annotation encoding="application/x-tex">M</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span></span></span></span> 进行加密称为密文 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>m</mi><mi>A</mi></msub></mrow><annotation encoding="application/x-tex">m_A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">A</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>；</li>
<li>密文 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi></mrow><annotation encoding="application/x-tex">m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">m</span></span></span></span> 传输到 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi></mrow><annotation encoding="application/x-tex">B</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span> 处， <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi></mrow><annotation encoding="application/x-tex">B</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span> 通过 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mi>r</mi><mi>i</mi><msub><mi>K</mi><mi>B</mi></msub></mrow><annotation encoding="application/x-tex">PriK_B</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">i</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 对消息解密回 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>M</mi><mi>A</mi></msub></mrow><annotation encoding="application/x-tex">M_A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.109em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">A</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>；</li>
<li>然后 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi></mrow><annotation encoding="application/x-tex">B</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span> 使用 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mi>u</mi><mi>b</mi><msub><mi>K</mi><mi>A</mi></msub></mrow><annotation encoding="application/x-tex">PubK_A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord mathnormal">u</span><span class="mord mathnormal">b</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">A</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 对消息 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>M</mi><mi>A</mi></msub></mrow><annotation encoding="application/x-tex">M_A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.109em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">A</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 进行校验；</li>
</ol>
<p><img src="../../../../assets/%E5%AE%89%E5%85%A8/%E6%9D%82/%E7%AD%BE%E5%90%8D%E5%92%8C%E5%8A%A0%E5%AF%86%E9%A1%BA%E5%BA%8F/58d3f5e4fe8d8673a7b2b30572e1c20701628353a7d496cb4d06e35cbca28543.png" alt="picture 4"></p>
<p>上述过程安全的保证来自于， <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal">A</span></span></span></span> 和 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi></mrow><annotation encoding="application/x-tex">B</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span> 的私钥是各自持有，不为第三方所知。<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal">A</span></span></span></span> <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi></mrow><annotation encoding="application/x-tex">B</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span> 间可以约定一个固定的字符串，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal">A</span></span></span></span> 使用 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal">A</span></span></span></span> 的私钥对该字符串进行加密，然后将该字符串的密文附加在消息中，这串密文的作用类似于签名。 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi></mrow><annotation encoding="application/x-tex">B</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span> 收到该密文后，可以使用 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal">A</span></span></span></span> 的公钥解密，校验该字符串是否为约定的字符串，这便可以校验签名是否为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal">A</span></span></span></span> 的。</p>
<p>一般来说，我们说加密能保证消息的机密性，签名能防止篡改，但是如果顺序不对还是会产生攻击的漏洞。</p>
<p>看这种情况：</p>
<p><img src="../../../../assets/%E5%AE%89%E5%85%A8/%E6%9D%82/%E7%AD%BE%E5%90%8D%E5%92%8C%E5%8A%A0%E5%AF%86%E9%A1%BA%E5%BA%8F/3551efd2bd512906f97b97d2dc7a174e3f3f4c1bad5300a22400160ca94d88dd.png" alt="picture 6"></p>
<p>从上图可知，先签名后加密的话，存在中间人攻击的风险。</p>
<p>虽然存在风险，但如果这种风险能够被消解，那么先加密后签名的方案也是可行的。</p>
<p>中间人攻击能够成功的前提是：</p>
<ol>
<li>接收方 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi></mrow><annotation encoding="application/x-tex">B</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span> 从签名的内容中找到对应的公钥 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi></mrow><annotation encoding="application/x-tex">M</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span></span></span></span> 来验证签名；</li>
<li>接收方 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi></mrow><annotation encoding="application/x-tex">B</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span> 只用公钥签名认证消息的发送方；</li>
</ol>
<p>这两个前提都要满足才有构成中间人攻击的条件，所以能否使用先加密后签名的方案也需要看具体的场景。如果 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi></mrow><annotation encoding="application/x-tex">B</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span> 使用固定的公钥来验证签名，比如通信双方约定一个可信的公证人，使用其签名保证消息无篡改；如果消息中带有用户身份的属性，比如用户的 ID 等，那么消息解密后 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi></mrow><annotation encoding="application/x-tex">B</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span> 通过验证 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal">A</span></span></span></span> 的用户属性，那也能确认消息是 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal">A</span></span></span></span> 发出的（这时，这个用户属性充当了前面签名的角色，其实还是一种先签名后加密）。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/07/17/article/%E8%AE%A1%E7%AE%97%E6%9C%BA/%E5%AE%89%E5%85%A8/%E8%AE%A4%E8%AF%81/Kerberos%E8%AE%A4%E8%AF%81/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/07/17/article/%E8%AE%A1%E7%AE%97%E6%9C%BA/%E5%AE%89%E5%85%A8/%E8%AE%A4%E8%AF%81/Kerberos%E8%AE%A4%E8%AF%81/" class="post-title-link" itemprop="url">Kerberos认证</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-07-17 00:00:00" itemprop="dateCreated datePublished" datetime="2022-07-17T00:00:00+08:00">2022-07-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-02-01 01:22:05" itemprop="dateModified" datetime="2025-02-01T01:22:05+08:00">2025-02-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/article/" itemprop="url" rel="index"><span itemprop="name">article</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/article/%E8%AE%A1%E7%AE%97%E6%9C%BA/" itemprop="url" rel="index"><span itemprop="name">计算机</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/article/%E8%AE%A1%E7%AE%97%E6%9C%BA/%E5%AE%89%E5%85%A8/" itemprop="url" rel="index"><span itemprop="name">安全</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/article/%E8%AE%A1%E7%AE%97%E6%9C%BA/%E5%AE%89%E5%85%A8/%E8%AE%A4%E8%AF%81/" itemprop="url" rel="index"><span itemprop="name">认证</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="Kerberos-认证">Kerberos 认证</h2>
<h3 id="引导">引导</h3>
<p>以 Windows 登录过程来引入，当用户按下 <code>Ctrl</code> + <code>Alt</code> + <code>Del</code> 时， Winlogon 服务将会被调用，同时提示用户输入用户名和密码。 Winlogon 读取完用户的身份凭证之后，会把它交给本地安全机构（LSA），LSA 对用户凭证进行加密操作比如 MD4 加密，加密后交给 SSPI （安全支持提供者接口），该接口负责与 Kerberos 和 NTLM 服务沟通。 LSA 根据用户输入的 UPN 等信息会事先把身份认证请求传到 Kerberos SSP 中。</p>
<p>Kerberos SSP 验证用户登入目标是本地计算机还是域，如果是域则继续向下处理，如果是本地计算机则会向 SSPI 返回一条错误消息， SSPI 将这个任务交回给 GINA 处理。</p>
<p>SSPI 现在发送请求到下一个安全提供程序，NTLM 。NTLM SSP 会将请求交给 Netlogon 服务针对 LSAM (Local Security Account Manager，本地安全账户管理器)数据库进行身份认证。使用 NTLM SSP 的身份认证过程与 Windows NT 系统的身份认证方法是相同的。</p>
<p><img src="../../../../assets/%E5%AE%89%E5%85%A8/%E8%AE%A4%E8%AF%81/Kerberos%E8%AE%A4%E8%AF%81/2da7dce4627606e18549b8fd770c54f9c54bed8846493242b8fcd579221447de.png" alt="picture 2"></p>
<h3 id="基础概述">基础概述</h3>
<ul>
<li>一个思想：Kerberos 认证只做认证，不鉴权，鉴权是服务账户所做的；</li>
<li>关键角色：
<ul>
<li>PAC</li>
<li>KDC</li>
<li>TGT</li>
</ul>
</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/07/13/article/%E8%AE%A1%E7%AE%97%E6%9C%BA/%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1%E8%AF%AD%E8%A8%80/Java/%E5%A4%9A%E7%BA%BF%E7%A8%8B/%E5%A4%9A%E7%BA%BF%E7%A8%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/07/13/article/%E8%AE%A1%E7%AE%97%E6%9C%BA/%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1%E8%AF%AD%E8%A8%80/Java/%E5%A4%9A%E7%BA%BF%E7%A8%8B/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" class="post-title-link" itemprop="url">多线程</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-07-13 00:00:00" itemprop="dateCreated datePublished" datetime="2022-07-13T00:00:00+08:00">2022-07-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-02-01 01:54:09" itemprop="dateModified" datetime="2025-02-01T01:54:09+08:00">2025-02-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/article/" itemprop="url" rel="index"><span itemprop="name">article</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/article/%E8%AE%A1%E7%AE%97%E6%9C%BA/" itemprop="url" rel="index"><span itemprop="name">计算机</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/article/%E8%AE%A1%E7%AE%97%E6%9C%BA/%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1%E8%AF%AD%E8%A8%80/" itemprop="url" rel="index"><span itemprop="name">程序设计语言</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/article/%E8%AE%A1%E7%AE%97%E6%9C%BA/%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1%E8%AF%AD%E8%A8%80/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/article/%E8%AE%A1%E7%AE%97%E6%9C%BA/%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1%E8%AF%AD%E8%A8%80/Java/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" itemprop="url" rel="index"><span itemprop="name">多线程</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="多线程">多线程</h2>
<h3 id="CAS">CAS</h3>
<p><strong>CAS</strong>（Compare And Swap）：比较并替换，CAS 机制定义了三个基本的操作数：内存地址 V ，预期值 A ，要修改成值 B 。<br>
当更新一个变量时，只有当地址 V 的变量为预期值 A 才将地址 V 中的值替换为值 B 。<br>
考虑两个线程都在更新某个变量的场景：</p>
<ol>
<li>线程 1 想要将 V 出的值 10 增加 1 ，此时对于地址 V 变量的预期值为 10 ，要更新为 11；</li>
<li>线程 1 执行更新操作时， CPU 被线程 2 抢占，地址 V 被抢先一步更新为 11 ；</li>
<li>线程 1 开始执行更新操作时，<strong>比较</strong>地址 V 的值发现和预期值 10 不一样，更新失败；</li>
<li>线程 1 重新获取地址 V 的值 11 ，要更新为新值 12 ，这个重试的操作被称为 <strong>自旋</strong>；</li>
<li>这次线程 1 没有被抢占，<strong>比较</strong>地址 V 的值发现和预期值 11 相同，进行<strong>交换</strong>操作，将地址 V 的值替换为 12；</li>
</ol>
<p>CAS 对于并发程度的估计是乐观的，所以让线程不断地重试之前的操作，分类上叫 <strong>乐观锁</strong>。<br>
而 Synchronized 属于 <strong>悲观锁</strong> ，对并发程度的估计是悲观的，所以对资源的访问严防死守。</p>
<p>在 Java 中 Atomic 系列类和 Lock 系列类的底层实现都是使用 CAS 机制实现的。</p>
<h4 id="实现原理">实现原理</h4>
<p>以 <code>incrementAndGet()</code> 方法为例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">incrementAndGet</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">current</span> <span class="operator">=</span> get();</span><br><span class="line">        <span class="type">int</span> <span class="variable">next</span> <span class="operator">=</span> current + <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> (compareAndSet(current, next))</span><br><span class="line">            <span class="keyword">return</span> next;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">int</span> value;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">get</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这段代码是一个无限循环，也叫做 <strong>自旋</strong> ，循环主要完成：</p>
<ol>
<li>获取当前值；</li>
<li>对值进行 +1 操作，计算出目标值；</li>
<li>进行 CAS 操作，如果成功则跳出循环，如果失败则重复上述步骤；</li>
</ol>
<p>这里通过 <code>volatile</code> 保证获取的值是当前的最新值。</p>
<p>接下来看 <code>compareAndSet()</code> 的实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">compareAndSet</span><span class="params">(<span class="type">int</span> expect, <span class="type">int</span> update)</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> unsafe.compareAndSwapInt(<span class="built_in">this</span>, valueOffset, expect, update);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Usafe</span> <span class="variable">unsafe</span> <span class="operator">=</span> Unsafe.getUnsafe();</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> valueOffset;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    valueOffset = unsafe.objectFieldOffset(AtomicInteger.class.getDeclareField(<span class="string">&quot;value&quot;</span>));</span><br><span class="line">  &#125; <span class="keyword">catch</span>(Exception ex) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(ex);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>compareAndSet()</code> 方法实现很简单，只有一行代码。涉及到两个对象，一个是 <strong>unsafe</strong> 一个是 <strong>valueOffset</strong> 。</p>
<p><strong>unsafe</strong> 是 JVM 提供的后门，给 Java 提供了 <strong>硬件级别的原子操作</strong> 。<br>
<strong>valueOffset</strong> 对象是通过 <code>unsafe.objectFieldOffset()</code> 方法得到的，代表的是 <code>AtomicInteger</code> 对象 value 成员变量在内存中的偏移量。可以简单理解为 value 变量的内存地址；</p>
<p>这里的 valueOffset 、 expect 、 update 分别代码 CAS 的内存地址 V 、 预期值 A 和新值 B 。正是 unsafe 提供的 <code>compareAndSwapInt()</code> 方法包括了这三个基本元素，保证了 Compare 和 Swap 操作的原子性。</p>
<h5 id="CAS-的缺点">CAS 的缺点</h5>
<ol>
<li>CPU 开销大，在并发程度高的时候，大量线程都在重复尝试更新变量，耗费了大量的时间 在空转；</li>
<li>不能保证 <strong>代码块</strong> 的原子性，只能保证针对 <strong>某个变量</strong> 操作的原子性，而无法同时保证多个变量的操作是原子的，这时候就不得不使用 synchronized 了；</li>
<li><strong>ABA 问题</strong> ，由于线程只关心最新的值是否为预期值，所以线程并不知道变量在 <code>compareAndSet()</code> 之前是否经历过从 A 变为 B 又变为 A 的过程，会直接通过检测，这在某些场景下会产生错误；为了解决这个问题，引入了版本号的机制，每次比较的时候还要加上版本号一起比较，当提交了修改之后，版本号 +1 ，这样便让 <code>compareAndSet()</code> 方法更确切地保证在更新之前值没有被更新过；</li>
</ol>
<h3 id="偏向锁">偏向锁</h3>
<p>jdk 1.5 以前 Java 的并发问题都是使用 <strong>Synchronized</strong> 解决的，这种 <strong>重量级锁</strong> 依赖于操作系统的调度，需要频繁在用户态和内核态之间切换，效率不行；</p>
<p>后来出现了 CAS 使用，失败-重试机制，使加锁和释放锁的过程不需要上下文切换，竞争不激烈时有不错的性能。但是经过研究发现，大多数情况下，获得锁的都是同一个线程，即使是轻量级锁的方式获取，但还是会影响性能。<br>
偏心锁在 CAS 的基础上，添加了了偏心机制，锁对象会记住线程的 ID ，当线程再次获取锁时，锁对象发现和上次的一样，就直接把锁给他。这种锁考虑的是只有一个线程进入临界区的情况。当有多个线程进入临界区时，为了提高效率，会被升级成 <strong>轻量级锁</strong> 也即 CAS ，如果竞争进一步加剧，那就会升级成 <strong>重量级锁</strong>。</p>
<p>偏向锁和轻量级锁都不会调用 <strong>系统互斥量</strong> （Mutex Lock），只是为了提升性能而多出的两种锁的状态，以便在不同场景下采取合适的锁。</p>
<blockquote>
<p>互斥量：是保证关键指令的原子性的一种机制，是最简单的线程同步方法。互斥量往往处于两种状态之一：解锁和加锁，就像厕所格子间的门锁，多人前来上厕所时，先进去的人把门锁锁上了，后面的人看到门上的状态是红的，说明有人在用，只能排队等待。是 <strong>操作系统级别</strong> 的线程同步方式。</p>
</blockquote>
<p>Java 对象的锁的信息是维护在 <strong>对象头</strong> 上的， Java 对象头由三部分构成：</p>
<ol>
<li>MarkWord（对象锁信息维护在这里）</li>
<li>ClassMetaData Address</li>
<li>Array Length (如果是数组对象才会有)</li>
</ol>
<p><img src="../../../../../assets/%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1%E8%AF%AD%E8%A8%80/Java/%E5%A4%9A%E7%BA%BF%E7%A8%8B/%E5%A4%9A%E7%BA%BF%E7%A8%8B/457d78882154a8d0cbc9ef4829ce479dcf0ccb40f612d8473e26b72e7c4e9784.png" alt="picture 3"></p>
<p>从左到右，高位到低位，由于还有 GC 标志位，加上四个锁状态，至少需要 3 bit 来描述一个对象的锁状态，如上图所示。</p>
<p>虽然说 jdk 1.6 版本后，是默认开启偏向锁的，但是实际上，由于 Java 中大量的 <code>synchronized</code> 的使用，直接开启偏向锁，进入同步块竞争的时候，就需要有锁升级，会带来额外的性能损耗。因此， JVM 提供了延迟策略，程序启动后大约 4s 后才会开启偏向锁。</p>
<h3 id="happen-before-原则">happen-before 原则</h3>
<p>Java 提供了三种方式保证程序执行结果的有序性：</p>
<ol>
<li><code>volatile</code> ；</li>
<li><code>synchronized</code> ；</li>
<li><code>Lock</code> ；</li>
</ol>
<p>此外， Java 的内存模型具备天生的有序性，不需要任何的同步手段即可保证，这些规则又被叫做 <strong>happens-before 原则</strong>；</p>
<p>具体有：</p>
<ol>
<li>程序次序规则</li>
<li>锁定规则</li>
<li><code>volatile</code> 变量规则</li>
<li>传递规则</li>
<li>线程启动规则</li>
<li>线程中断规则</li>
<li>线程的终结规则</li>
<li>对象的终结规则</li>
</ol>
<p><strong>volatile 关键字具有保证顺序性的语义</strong> 。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/07/13/article/%E8%AE%A1%E7%AE%97%E6%9C%BA/%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1%E8%AF%AD%E8%A8%80/Java/%E5%A4%9A%E7%BA%BF%E7%A8%8B/%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%AE%9E%E7%8E%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/07/13/article/%E8%AE%A1%E7%AE%97%E6%9C%BA/%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1%E8%AF%AD%E8%A8%80/Java/%E5%A4%9A%E7%BA%BF%E7%A8%8B/%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%AE%9E%E7%8E%B0/" class="post-title-link" itemprop="url">多线程实现</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-07-13 00:00:00" itemprop="dateCreated datePublished" datetime="2022-07-13T00:00:00+08:00">2022-07-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-02-01 01:54:09" itemprop="dateModified" datetime="2025-02-01T01:54:09+08:00">2025-02-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/article/" itemprop="url" rel="index"><span itemprop="name">article</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/article/%E8%AE%A1%E7%AE%97%E6%9C%BA/" itemprop="url" rel="index"><span itemprop="name">计算机</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/article/%E8%AE%A1%E7%AE%97%E6%9C%BA/%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1%E8%AF%AD%E8%A8%80/" itemprop="url" rel="index"><span itemprop="name">程序设计语言</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/article/%E8%AE%A1%E7%AE%97%E6%9C%BA/%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1%E8%AF%AD%E8%A8%80/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/article/%E8%AE%A1%E7%AE%97%E6%9C%BA/%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1%E8%AF%AD%E8%A8%80/Java/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" itemprop="url" rel="index"><span itemprop="name">多线程</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="多线程实现">多线程实现</h2>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/06/26/article/%E8%AE%A1%E7%AE%97%E6%9C%BA/%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1%E8%AF%AD%E8%A8%80/Java/JVM/%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/06/26/article/%E8%AE%A1%E7%AE%97%E6%9C%BA/%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1%E8%AF%AD%E8%A8%80/Java/JVM/%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B/" class="post-title-link" itemprop="url">内存模型</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-06-26 00:00:00" itemprop="dateCreated datePublished" datetime="2022-06-26T00:00:00+08:00">2022-06-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-02-01 01:54:09" itemprop="dateModified" datetime="2025-02-01T01:54:09+08:00">2025-02-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/article/" itemprop="url" rel="index"><span itemprop="name">article</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/article/%E8%AE%A1%E7%AE%97%E6%9C%BA/" itemprop="url" rel="index"><span itemprop="name">计算机</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/article/%E8%AE%A1%E7%AE%97%E6%9C%BA/%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1%E8%AF%AD%E8%A8%80/" itemprop="url" rel="index"><span itemprop="name">程序设计语言</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/article/%E8%AE%A1%E7%AE%97%E6%9C%BA/%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1%E8%AF%AD%E8%A8%80/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/article/%E8%AE%A1%E7%AE%97%E6%9C%BA/%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1%E8%AF%AD%E8%A8%80/Java/JVM/" itemprop="url" rel="index"><span itemprop="name">JVM</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="内存模型">内存模型</h2>
<h3 id="HotSpot-JVM-架构">HotSpot JVM 架构</h3>
<p><img src="../../../../../assets/%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1%E8%AF%AD%E8%A8%80/Java/JVM/%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B/a9cec5474a1a9b1da2c4b6b7b9030194a4015d71ff7981dd0a7d56059220e86a.png" alt="picture 5"></p>
<p>由于 Java 的内存管理是由 JVM 自己实现的， Java 程序员编写代码时无需关注内存的使用情况，避免了将内存管理逻辑实现在代码中，能更好地描述业务，减少代码的冗余。但如果编写代码时对于 JVM 如何管理内存没有了解，一旦出现问题则无法定位修复问题。</p>
<h3 id="内存布局">内存布局</h3>
<p>根据 JVM 规范，在运行时，内存会被分为以下几个数据区域：</p>
<p><img src="../../../../../assets/%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1%E8%AF%AD%E8%A8%80/Java/JVM/%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B/eaae6c32c4ed28431bf80beb0b0148009cf36631c4a371d50cd7306e7ebf25fe.png" alt="picture 1"></p>
<h4 id="程序计数器（Program-Counter-Register）">程序计数器（Program Counter Register）</h4>
<p>程序计数器(Program Counter Register)用来指示程序下一次的执行位置，程序的控制流实现依赖于它。由于 JVM 的多线程是在多个线程间轮流切换、分配处理器的执行时间来实现的，所以<strong>每个线程需要私有程序计数器</strong>，以方便在线程切换后恢复自己的运行位置。</p>
<p>程序计数器会记录 Java 方法的虚拟机字节码指令的地址，但执行到本地(Native) 方法时，该处会为空(undefined)。并且该区域是 JVM 规范中 <strong>唯一没有规定任何 OutOfMemoryError</strong>情况的区域。</p>
<h4 id="虚拟机栈（VM-Stack）">虚拟机栈（VM Stack）</h4>
<p><img src="../../../../../assets/%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1%E8%AF%AD%E8%A8%80/Java/JVM/%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B/44a97062ea830c63a6fed4dd185edac38b5620c6eac9e2525bcc40dd9e7827d9.png" alt="picture 6"></p>
<p>虚拟机栈(VM Stack)是描述方法执行的内存模型，每个方法被执行的时候都会同步创建一个<strong>栈帧</strong>(Stack Frame)，用于存储<strong>局部变量表</strong>（方法内定义的局部变量）、<strong>操作数栈</strong>（方法内对变量的操作）、<strong>动态链接</strong>（调用别的方法）、<strong>方法出口</strong>（返回值）等信息。每个方法的执行过程对应一个栈帧的入栈和出栈的过程。当线程执行完毕时，意味着没有方法需要执行了，所以虚拟机栈也销毁了。</p>
<blockquote>
<p>按照 C/C++ 的划分，内存区域被笼统地划分为 <strong>栈</strong> 和 <strong>堆</strong> 两部分，在 JVM 中，这个栈通常指的就是虚拟机栈，或者更多情况下，指的是虚拟机栈中存储的局部变量表。</p>
</blockquote>
<p>在 JVM 规范中，这个内存区域会产生两类异常状况：</p>
<ol>
<li>如果线程请求的栈的深度大于虚拟机所允许的深度，会产生 <strong>StackOverflowError</strong> 异常；</li>
<li>如果 JVM 的容量可以动态扩展，而栈扩展时无法申请足够的内存会抛出 <strong>OutOfMemoryError</strong> 异常；</li>
</ol>
<p>可以使用 <code>-Xss</code> 调整栈内存空间；</p>
<h5 id="局部变量表">局部变量表</h5>
<p>存放了 <strong>编译期间</strong> 得知的 JVM <strong>基本类型</strong>（boolean、byte、int、……）、<strong>对象引用</strong>（reference 类型，或者说指向对象的指针）和 <strong>returnAddress 类型</strong>（指向一条字节码指令的地址）。这些数据类型的存储空间单位用局部变量槽（Slot）来表示，64 位长度的 long 和 double 类型占用两个 Slot ，其余变量只占用一个。局部变量表的空间在编译期就设定好了，因为方法运行期间不会再创建新的局部变量。</p>
<blockquote>
<p>具体一个 Slot 有多大取决于 JVM 的具体实现。</p>
</blockquote>
<h4 id="本地方法栈">本地方法栈</h4>
<p>本地方法栈（Native Method Stack）与虚拟机栈的作用类似，区别只是一个是存放 Java 方法的数据，一个是存放本地方法的数据。该内存区域会抛出的错误和虚拟机栈的一样；</p>
<h4 id="Java-堆">Java 堆</h4>
<p>Java 堆往往是虚拟机所管理的内存中最大的一块，该区域被所有线程共享。此区域的唯一目的就是存放对象的实例，几乎所有的对象都在这里分配内存空间。Java 堆不需要连续的内存，<br>
该区域的大小可以被实现为固定的，也可以实现为可拓展的，主流虚拟机都是实现为可拓展的（<code>-Xmx</code> 指定堆的最大值，<code>-Xms</code> 指定堆的初始大小），当堆的空间不足时，会抛出 <code>OutOfMemoryError</code> 异常。</p>
<p>Java 堆是垃圾收集器所管理的内存区域，所以也叫 <strong>GC 堆</strong> (Garbage Collected Heap) ，目前大多的垃圾回收器都是基于分代收集理论实现的，所以 Java 堆中经常会出现 <strong>新生代</strong> 、 <strong>老年代</strong> 、 <strong>永久代</strong> 、 <strong>Eden</strong> 、 <strong>Survivor</strong> 等划分。这种划分是目前大多数垃圾收集器所规定的，而 JVM 规范中并没有规定这些划分。实际上，一些新兴的垃圾收集器技术并不是按照经典分代的理论实现的。</p>
<p>新生代使用 <code>-Xmn</code> 参数指定内存大小；<br>
Eden 区与 Survivor 区的比例使用 <code>-XX:SurvivorRatio</code> 指定；<br>
晋升老年代对象大小 <code>-XX:PretenureSizeThreshold</code> 指定；</p>
<h4 id="方法区">方法区</h4>
<p>方法区(Method Area) 和 Java 堆一样是线程共享的内存区域，用于存储已经被虚拟机加载的<strong>类型信息</strong>、<strong>常量</strong>、<strong>静态变量</strong>、即时编译器编译后的<strong>代码缓存</strong>等数据。</p>
<p>方法区是 JVM 规范中声明的一块内存区域，具体的实现在各家 JVM 厂商的产品中各有不同，在 HotSpot JVM 的 JDK 6 版本中，方法区又被叫做 <strong>永久代</strong> ，并将垃圾收集器的分代设计扩展到方法区中，省去了专门为方法区编写内存管理的工作。但这种设计使得 JVM 更容易发生 <strong>内存溢出</strong> ，因为永久代有 <code>-XX:MaxPermSize</code> 的上限，如果不设置有默认值，而其他 JVM 厂商使用 <strong>本地内存</strong> 的设计，只要没有达到进程的可用内存上限都可以继续使用，例如 32 位操作系统为 4GB ，都不会发生内存溢出。这种不一致导致 HotSpot 在吸收其他 JVM 的优点时产生了麻烦。在后续的 JDK 8 版本中，HotSpot JVM 也放弃了永久代，而采用 <strong>元空间</strong> （本地内存）来实现 JVM 的方法区。</p>
<h5 id="运行时常量池">运行时常量池</h5>
<p>运行时常量池（COnstant Pool Table）是方法区的一部分，用于存放编译期生成的各种 <strong>字面量</strong> （常量）和 <strong>符号引用</strong> ，这些内容将在类加载后存放到运行时常量中。<br>
不同于其他区域，这个区域 JVM 规范并没有提出任何细节上的要求。 Java 虚拟机对于 Class 文件的每个部分都有严格的要求，比如每个字节用于存放那种数据都必须符合 JVM 规范才能被加载和执行。<br>
一般说来，除了保存 Class 文件的符号引用外，常量池还会存放从符号引用翻译过来的直接引用。<br>
运行时常量池相对于 Class 文件常量池，还有 <strong>动态性</strong> ，并不是预先放入 Class 文件中的常量才会被放入运行时常量池中，运行期间也可以将新的常量放入池中，比如 <code>String.intern()</code> 方法。</p>
<h4 id="直接内存">直接内存</h4>
<p>直接内存（Direct Memory）不是 JVM 运行时的数据区域之一，也没有被 JVM 规范定义。但是在编码中会频繁使用，比如 JDK1.4 后加入的 <strong>NIO 类</strong>，这种基于<strong>通道</strong>（channel）和<strong>缓冲区</strong>（buffer）的 IO 类，可以使用 Native 方法直接分配堆外内存，然后通过一个存储在 Java 堆里的 <code>DirectByteBuffer</code> 对象作为这块内存的引用进行操作。这样避免了在 Java 堆和 Native 堆间来回复制数据。<br>
直接内存属于物理机本地的内存区域，通过 <code>-Xmx</code> 参数配置只能设置 Java 堆内存，因此在做虚拟机参数配置时，需要考虑到直接内存，如果直接将堆内存设置和物理机内存一致，就会突破物理机内存限制。比如说， 32 位计算机能够为一个进程分配的内存只有 2GB (根据位长计算得来，一台计算机不是所有的内存都可以用来跑一个进程，计算机可以运行多个进程)，假设 Java 堆已经分配了 1.6 GB 那么剩下的 0.4 GB 就是直接内存使用的空间。这 0.4 GB 就是直接内存，也被叫做<strong>堆外内存</strong>。</p>
<h3 id="对象的创建">对象的创建</h3>
<p>这里的对象指的是普通的 Java 对象，不包括数组和 Class 对象。当 JVM 遇到一个对象的 new 指令时，首先会去检查该指令的参数是否能在常量池中定位到一个类的符号引用，并检查该类是否被加载、解析和初始化过。如果没有，则首先要执行类加载过程。</p>
<p>类加载检查通过之后， JVM 将为对象 <strong>分配内存</strong> 。分配内存有两种方式：</p>
<ol>
<li>指针碰撞（Bump The Pointer），当 Java 堆是规整的时，就像进度条一样，一边是空闲的空间，一边是被占用的空间，为对象分配内存时，就是将分界指针向空闲一边移动；</li>
<li>空闲列表（Free List），当 Java 堆是不规整的， JVM 需要维护一张表格记录哪块内存是可用的，在分配空间的时候从列表中查出一块足够大的空间分配给对象；</li>
</ol>
<p>而 Java 堆是否规整是取决于垃圾收集器是否带有空间<strong>压缩整理</strong>（Compact）功能决定的，当使用 Serial 、 ParNew 等收集器时，系统采用指针碰撞的分配方法。当使用 CMS 这种基于<strong>清除</strong>（Sweep）算法的收集器时，理论上只能采用较为复杂的空闲列表来分配内存（实际上为了能够更快地分配内存， CMS 设计了一个叫做 Linear Allocation Buffer 的缓冲区，通过空闲列表拿到一大块空间分配缓冲区后，在缓冲区内仍可以使用指针碰撞的方式分配内存；</p>
<p>另外，在并发场景中分配内存还会面临线程不安全的问题，有两种解决方法：</p>
<ol>
<li>使用 CAS 失败重试的机制保证更新操作的原子性；</li>
<li>在每个线程中都分配缓冲区，称为 <strong>本地线程缓冲区</strong> （Thread Local Allocation Buffer， TLAB），每个线程先在自己的本地缓冲区分配内存，只有在本地缓冲区用完了，需要分配新的内存时才需要同步锁定；可以通过 -XX:+/-UseTLAB 参数来设定是否使用 TLAB 机制；</li>
</ol>
<blockquote>
<p><strong>CAS</strong>（Compare And Swap）：比较并替换，CAS 机制定义了三个基本的操作数：内存地址 V ，预期值 A ，要修改成值 B 。<br>
当更新一个变量时，只有当地址 V 的变量为预期值 A 才将地址 V 中的值替换为值 B 。<br>
考虑两个线程都在更新某个变量的场景：</p>
<ol>
<li>线程 1 想要将 V 出的值 10 增加 1 ，此时对于地址 V 变量的预期值为 10 ，要更新为 11；</li>
<li>线程 1 执行更新操作时， CPU 被线程 2 抢占，地址 V 被抢先一步更新为 11 ；</li>
<li>线程 1 开始执行更新操作时，<strong>比较</strong>地址 V 的值发现和预期值 10 不一样，更新失败；</li>
<li>线程 1 重新获取地址 V 的值 11 ，要更新为新值 12 ，这个重试的操作被称为 <strong>自旋</strong>；</li>
<li>这次线程 1 没有被抢占，<strong>比较</strong>地址 V 的值发现和预期值 11 相同，进行<strong>交换</strong>操作，将地址 V 的值替换为 12；</li>
</ol>
<p>CAS 对于并发程度的估计是乐观的，所以让线程不断地重试之前的操作，分类上叫 <strong>乐观锁</strong>。<br>
而 Synchronized 属于 <strong>悲观锁</strong> ，对并发程度的估计是悲观的，所以对资源的访问严防死守。</p>
<p>在 Java 中 Atomic 系列类和 Lock 系列类的底层实现都是使用 CAS 机制实现的。</p>
</blockquote>
<p>内存分配完成后， JVM 将分配的空间都 <strong>初始化为零值</strong> ，如果使用 TLAB 的话，这项工作可以提前至 TLAB 分配时进行。这是为了保证对象的实例字段可以不用赋初始值就可以直接使用。</p>
<p>然后， JVM 开始 <strong>设置对象头</strong> ，对象头包含了对象的一些元数据信息。</p>
<p>经历上面的步骤， 从 JVM 的视角看来，一个对象已经创建完成了，然而这时尚未进入 Java 程序的构造函数，即 Class 文件中的 <code>&lt;init&gt;()</code> 方法。 JVM 编译器在程序中遇到 <code>new</code> 关键字的地方同时生成 <code>new</code> 指令和 <code>invokespecial</code> 指令，<code>new</code> 指令后会接着执行 <code>&lt;init&gt;()</code> 方法。这时一个对象才真正被构造出来。</p>
<p>下面的代码片段来自于 Hotspot 的字节码解释器，可以用来描述前面所说的对象创建过程：</p>
<p><img src="../../../../../assets/%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1%E8%AF%AD%E8%A8%80/Java/JVM/%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B/b9f17c723c33a38135168812ddb4cbf1cc40e32542595c6b22d16a2419fd07ee.png" alt="picture 2"></p>
<h3 id="对象的内存布局">对象的内存布局</h3>
<p>对象在堆内存的存储分布如下：</p>
<ol>
<li>对象头（Header）</li>
<li>实例数据（Instance Data）</li>
<li>对齐填充（Padding）</li>
</ol>
<h4 id="对象头">对象头</h4>
<p>对象头部分包含两类信息：</p>
<ol>
<li>对象的运行时数据（<strong>Mark Word</strong>），哈希码、 GC 分代年龄、锁状态标志、线程持有的锁、偏向线程 ID 、偏向时间戳等；</li>
<li>类型指针，指向对象的类型元数据， JVM 通过该指针确定对象的类型。（该信息不是所有虚拟机实现都有，因为查找对象的元数据信息不一定要经过对象本身）</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/06/22/article/%E8%AE%A1%E7%AE%97%E6%9C%BA/%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1%E8%AF%AD%E8%A8%80/Java/Java%20IO/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/06/22/article/%E8%AE%A1%E7%AE%97%E6%9C%BA/%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1%E8%AF%AD%E8%A8%80/Java/Java%20IO/" class="post-title-link" itemprop="url">Java IO</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-06-22 00:00:00" itemprop="dateCreated datePublished" datetime="2022-06-22T00:00:00+08:00">2022-06-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-02-01 01:54:09" itemprop="dateModified" datetime="2025-02-01T01:54:09+08:00">2025-02-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/article/" itemprop="url" rel="index"><span itemprop="name">article</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/article/%E8%AE%A1%E7%AE%97%E6%9C%BA/" itemprop="url" rel="index"><span itemprop="name">计算机</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/article/%E8%AE%A1%E7%AE%97%E6%9C%BA/%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1%E8%AF%AD%E8%A8%80/" itemprop="url" rel="index"><span itemprop="name">程序设计语言</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/article/%E8%AE%A1%E7%AE%97%E6%9C%BA/%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1%E8%AF%AD%E8%A8%80/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="Java-IO">Java IO</h2>
<p>Java 提供了庞大的输入/输出 API 供开发者使用。在程序看来，所有的数据来源（磁盘 IO 、内存 IO 、网络 IO 、 ……）都可以看作是字节序列的读写，这个序列被称为 <strong>流</strong> 。具体来说，各种流的实现五花八门，所以 Java 提供了大量的流 IO 类给开发者。</p>
<p>按流的出入方向分，有两个抽象类： <code>InputStream</code> 和 <code>OutputStream</code> ；<br>
另外，为了方便读写 Unicode 文本（<code>char</code>），Java API 定义了 <code>Reader</code> 和 <code>Writer</code> ，从出入参可以看出，这些类是用于操作字符 <code>char</code> 的；</p>
<p><img src="../../../../assets/%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1%E8%AF%AD%E8%A8%80/Java/Java%20IO/156ab2410fcc549381cc37ac73843db03da780428721b26b7fd80e5bfc17f84b.png" alt="picture 2"></p>
<p>上述的每个抽象类都实现了 <code>AutoCloseable</code> 接口，因此都支持 <code>try-with-resource</code> 语法，即 <code>try(InputStream ...)&#123;&#125;</code> 的写法，可以在 <code>try</code> 块中自动调用关闭流的 <code>close()</code> 方法。</p>
<blockquote>
<p>为什么 <code>Closeable</code> 和 <code>AutoCloseable</code> 都有 <code>close()</code> 方法？<br>
因为 <code>Closeable</code> 方法的 <code>close()</code> 方法只抛出 <code>IOException</code> 但是 <code>AutoCloseable</code> 会抛出任何 <code>Exception</code> 。</p>
</blockquote>
<p>而 <code>OutputStream</code> 和 <code>Writer</code> 还实现了 <code>Flushable</code> 接口，接口中的 <code>flush()</code> 方法用于冲刷流中处于缓冲区的数据；</p>
<h3 id="读写字节">读写字节</h3>
<p><code>InputStream</code>/<code>OutputStream</code> 家族（ <code>FileInputStream</code> 、 <code>FileOutputStream</code> …）</p>
<p><code>InputStream</code> 和 <code>OutputStream</code> 的 <code>read()</code> 和 <code>write()</code> 方法都是阻塞的，执行时都会阻塞该线程到字节确实被读写，期间流如果暂时无法访问，则其他线程有机会抢占位置执行别的项目。<br>
如果使用 <code>avavilable()</code> 方法便可以判断此时可以获取多少个字节，下面的读取方式不可能被阻塞；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="variable">bytesAvailable</span>  <span class="operator">=</span> in.available();</span><br><span class="line"><span class="keyword">if</span> (bytesAvailable &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="type">var</span> <span class="variable">data</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">byte</span>[bytesAvailable];</span><br><span class="line">    in.read(data);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Java 9 开始可以使用如下 API 读入流终端的所有字节；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">byte</span>[] bytes = in.readAllBytes(); <span class="comment">// 一次读取所有的字节，其他的读取给定字节数的方法，都是调用 read() 方法，所以每个 InputStream 的子类都只需要重写 read() 方法即可</span></span><br><span class="line"></span><br><span class="line">in.transferTo(out); <span class="comment">// 可以将所有字节从 InputStream 传递到 OutputStream 中</span></span><br><span class="line"><span class="type">long</span> <span class="variable">m</span> <span class="operator">=</span> in.skip(n); <span class="comment">// 用于跳过指定的字节数，返回实际被跳过的字节数</span></span><br><span class="line">in.mark(readlimit); <span class="comment">// 在字节流的 readlimit 处</span></span><br></pre></td></tr></table></figure>
<p>对每个流操作完毕后都需要调用 <code>close()</code> 方法将其关闭，如果不关闭可能会有耗尽系统资源的风险。随着输出流的关闭，其输出缓冲区也会被关闭，缓冲区中的内容也会被冲刷出，如果不关闭流，那么流中的内容永远得不到传递。</p>
<p>实践中，我们会使用更具体的实现类来完成 IO 工作。比如 <code>FileInputStream</code> 读入文件流……</p>
<p><code>CharBuffer</code> 类表示内存中的缓冲区，拥有按顺序和随机读写访问的方法；</p>
<p><img src="../../../../assets/%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1%E8%AF%AD%E8%A8%80/Java/Java%20IO/24808671026264201c60003800b569f61fd30b7f3d742b0dbe9ff57aa08eb103.png" alt="picture 3"></p>
<p><code>CharSequence</code> 接口描述一个 <code>char</code> 值序列的基本属性，<code>String</code> 、 <code>CharBuffer</code> 、 <code>StringBuilder</code> 和 <code>StringBuffer</code> 类都实现了他。</p>
<h3 id="流的嵌套和组合">流的嵌套和组合</h3>
<p><code>FileInputStream</code> 和 <code>FileOutputStream</code> 提供了对磁盘文件的读写方法。但他们与父类 <code>InputStream</code> 和 <code>OutputStream</code> 一样，都只能读写字节，如果需要读写具体的类型，需要借助 <code>DataInputStream</code> 和 <code>DataOutputStream</code> 。这是 Java 提供的一种职责分离设计， <code>FileInputStream</code> / <code>FileOutputStream</code> 等类负责从外部的介质中读取字节流（控制台输入、内存、磁盘、网络等），<code>DataInputStream</code> <code>DataOutputStream</code> 和 <code>FilterInputStream</code> <code>FilterOutputStream</code> 负责将字节流解析成需要的类型。</p>
<p>我们通过嵌套使用这些流完成复杂的 IO 操作，比如我们想利用缓冲区完成更高效的 IO ，我们需要嵌套一个 <code>BufferedInputStream</code> <code>BufferedOutputStream</code> ：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">var</span> <span class="variable">din</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DataInputStream</span>(</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">BufferedInputStream</span>(</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;employee.dat&quot;</span>)</span><br><span class="line">    )</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>有时我们需要预览即将读入的下一个字节是否我们想要的，这时我们需要嵌套 <code>PushbackInputStream</code> ：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">var</span> <span class="variable">pbin</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PushbackInputStream</span>(</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">BufferedInputStream</span>(</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;employee.dat&quot;</span>)</span><br><span class="line">    )</span><br><span class="line">);</span><br><span class="line"><span class="type">int</span> <span class="variable">b</span> <span class="operator">=</span> pbin.read();</span><br><span class="line"><span class="keyword">if</span> (b != <span class="string">&#x27;&lt;&#x27;</span>) <span class="comment">// 如果不是自己期望的结果，可以使用 unread() 方法将其推回到流中</span></span><br><span class="line">    pbin.unread(b);</span><br></pre></td></tr></table></figure>
<p>从流中读取一个字节时，使用 <code>int</code> 接收，<strong>不可以</strong>用 <code>byte</code> 和 <code>char</code> 接收：</p>
<ul>
<li>使用 <code>byte</code> 接收，可能流中返回 <code>0xFF</code> ，转换为 <code>byte</code> 后会变为 <code>-1</code> 导致误判为到达流的末尾；</li>
<li>使用 <code>char</code> 接收，当流到达末尾返回 <code>0xFFFFFFFF</code> ，转换为 <code>char</code> 被截断成 <code>0xFFFF</code> ，此时的 <code>char</code> 也是不等于 <code>-1</code> 的，程序无法正常退出；</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">char</span> <span class="variable">eof</span> <span class="operator">=</span> (<span class="type">char</span>) <span class="number">0xFFFF</span>;</span><br><span class="line">    <span class="type">byte</span> <span class="variable">beof</span> <span class="operator">=</span> (<span class="type">byte</span>) <span class="number">0xFF</span>;</span><br><span class="line">    System.out.println(eof == -<span class="number">1</span>); <span class="comment">// fasle</span></span><br><span class="line">    System.out.println(beof == -<span class="number">1</span>); <span class="comment">// true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>正确写法如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 字节流</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String args)</span> &#123;</span><br><span class="line">    <span class="type">FileInputStream</span> <span class="variable">in</span> <span class="operator">=</span> getReadableStream();</span><br><span class="line">    <span class="type">byte</span> data;</span><br><span class="line">    <span class="type">int</span> result;</span><br><span class="line">    <span class="keyword">while</span>((result = in.read()) != -<span class="number">1</span>) &#123;</span><br><span class="line">        data = (<span class="type">byte</span>) result;</span><br><span class="line">        <span class="comment">// 使用 data</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 字符流</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String args)</span> &#123;</span><br><span class="line">    <span class="type">InputStreamReader</span> <span class="variable">in</span> <span class="operator">=</span> getReader();</span><br><span class="line">    <span class="type">char</span> data;</span><br><span class="line">    <span class="type">int</span> result;</span><br><span class="line">    <span class="keyword">while</span> ((result = in.read()) != -<span class="number">1</span>) &#123;</span><br><span class="line">        data = (<span class="type">char</span>)result;</span><br><span class="line">        <span class="comment">// 使用 data</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/06/22/article/%E8%AE%A1%E7%AE%97%E6%9C%BA/%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1%E8%AF%AD%E8%A8%80/Java/JVM/%E7%B1%BB%E5%8A%A0%E8%BD%BD%E6%9C%BA%E5%88%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/06/22/article/%E8%AE%A1%E7%AE%97%E6%9C%BA/%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1%E8%AF%AD%E8%A8%80/Java/JVM/%E7%B1%BB%E5%8A%A0%E8%BD%BD%E6%9C%BA%E5%88%B6/" class="post-title-link" itemprop="url">类加载机制</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-06-22 00:00:00" itemprop="dateCreated datePublished" datetime="2022-06-22T00:00:00+08:00">2022-06-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-02-01 01:54:09" itemprop="dateModified" datetime="2025-02-01T01:54:09+08:00">2025-02-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/article/" itemprop="url" rel="index"><span itemprop="name">article</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/article/%E8%AE%A1%E7%AE%97%E6%9C%BA/" itemprop="url" rel="index"><span itemprop="name">计算机</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/article/%E8%AE%A1%E7%AE%97%E6%9C%BA/%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1%E8%AF%AD%E8%A8%80/" itemprop="url" rel="index"><span itemprop="name">程序设计语言</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/article/%E8%AE%A1%E7%AE%97%E6%9C%BA/%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1%E8%AF%AD%E8%A8%80/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/article/%E8%AE%A1%E7%AE%97%E6%9C%BA/%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1%E8%AF%AD%E8%A8%80/Java/JVM/" itemprop="url" rel="index"><span itemprop="name">JVM</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="类加载机制">类加载机制</h2>
<h3 id="类的加载过程">类的加载过程</h3>
<p>类的加载过程：（Load-Link-Initialize）</p>
<p><img src="../../../../../assets/%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1%E8%AF%AD%E8%A8%80/Java/JVM/%E7%B1%BB%E5%8A%A0%E8%BD%BD%E6%9C%BA%E5%88%B6/1323eba348af5a32881cfe4ee34f5bbf375177e4fb0d9fc710368affb015b2f5.png" alt="picture 4"></p>
<ol>
<li>类的加载（Load）：
<ul>
<li>通过类的全限定名获取定义此类的二进制字节流；</li>
<li>将这个字节流所代表的静态存储结构转化为方法区的运行时数据结构；</li>
<li>在内存中创建一个代表这个类的 <code>java.lang.Class</code> 对象，作为方法区这个类的各种数据的访问入口；</li>
<li>整个过程由类加载器完成；</li>
</ul>
</li>
<li>类的链接（Link）：将类的二进制数据合并到 JRE 中；
<ul>
<li>验证：确保加载的类信息符合 JVM 规范，不会出现安全问题；</li>
<li>准备：正式为 <strong>类变量</strong> （static 变量，不包括 static final 常量，常量在编译阶段便分配了内存，准备阶段会显式初始化）分配内存并设置 <strong>默认初始值</strong> （零值），这些内存都在 <strong>方法区</strong> 中进行分配；</li>
<li>解析：虚拟机常量池内的符号引用（常量名）替换为直接引用（地址）的过程；</li>
</ul>
</li>
<li>类的初始化（Initialize）：JVM 负责对类进行初始化；
<ul>
<li>执行类构造器 <code>&lt;clinit&gt;()</code> 方法的过程。类构造器 <code>&lt;clinit&gt;()</code> 方法，是由编译器自动收集类中所有 <strong>类变量</strong> 的赋值和 <strong>静态代码块</strong> 中的语句合并产生的；（类构造器是构造类信息的，不是构造类对象的）</li>
<li>当初始化一个类的时候，如果发现其父类还没有初始化，则需要先触发其父类的初始化；（双亲委派机制）</li>
<li>虚拟机会保证一个类的方法在多线程的环境中被正确加锁和同步；</li>
</ul>
</li>
</ol>
<blockquote>
<p>看一段代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">Integer</span> <span class="variable">a</span> <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line">   a = <span class="number">3</span>;</span><br><span class="line">   num = <span class="number">200</span>; <span class="comment">// 这里的赋值是合法的，因为 static 变量在 linking 阶段的 prepare 就已经分配了内存并设置了初始默认值，所以这里的赋值是成功的</span></span><br><span class="line">   <span class="comment">// System.out.println(num); // 这是会编译出错的，会发生非法的前向引用错误</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">num</span> <span class="operator">=</span> <span class="number">10</span>;</span><br></pre></td></tr></table></figure>
</blockquote>
<h4 id="类的初始化">类的初始化</h4>
<p>类的初始化触发分为下面两种情况：</p>
<ol>
<li>类的主动引用（一定会发生类的初始化）
<ul>
<li>当虚拟机启动，先初始化 ma`in 方法所在的类；</li>
<li><code>new</code> 一个类的对象；</li>
<li>调用类的静态成员（除了 <code>final</code> 常量）和静态方法；</li>
<li>使用 <code>java.lang.reflect</code> 包的方法对类进行反射调用；</li>
<li>当初始化一个类，如果其父类没有被初始化，则先会初始化它的父类；</li>
<li>JDK 7 开始提供了动态语言的支持：
<ul>
<li><code>java.lang.invoke.MethodHandle</code> 实例的解析结果；</li>
<li><code>REF_getStatic</code> 、 <code>REF_putStatic</code> 、 <code>REF_invokeStatic</code> 句柄对应的类没有初始化，则初始化；</li>
</ul>
</li>
</ul>
</li>
<li>类的被动引用（不会发生类的初始化）
<ul>
<li>当访问一个静态域时，只有真正声明这个域的类才会被初始化。如：当通过子类引用父类的静态变量，不会导致子类初始化；</li>
<li>通过数组定义类引用，不会触发此类的初始化，<code>Son[] array = new Son[5];</code>；</li>
<li>引用常量不会触发此类的初始化（常量在链接阶段就存入调用类的常量池中了）；</li>
<li>其他操作……</li>
</ul>
</li>
</ol>
<h5 id="执行-clinit">执行 <code>&lt;clinit&gt;()</code></h5>
<p>类的初始化阶段就是执行类构造器 <code>&lt;clinit&gt;()</code> 方法。<br>
<code>&lt;clinit&gt;()</code> 由编译器自动收集的，所有 <strong>类变量的赋值动作</strong> 和 <strong>静态语句块</strong>，合并产生的。收集顺序由源码的出现顺序决定。<br>
静态语句块中只能访问定义在其之前的变量，对于定义在其后的变量，语句块能够 <strong>赋值</strong> ， <strong>不能访问</strong> （会报非法向前引用变量的错误）。</p>
<p><code>&lt;clinit&gt;()</code> 方法与类的构造函数（<code>&lt;init&gt;()</code> 方法不同），它不需要显式地调用父类构造器，虚拟机会自己保证父类的 <code>&lt;clinit&gt;()</code> 先执行。所以最先执行的 <code>&lt;clinit&gt;()</code> 是 <code>java.lang.Object</code> 的。</p>
<h3 id="实例：分析下面代码的加载过程">实例：分析下面代码的加载过程</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ClinitTest1</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Father</span> &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">A</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">static</span> &#123;</span><br><span class="line">            A = <span class="number">2</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Son</span> <span class="keyword">extends</span> <span class="title class_">Father</span> &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">B</span> <span class="operator">=</span> A;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        System.out.println(Son.B); <span class="comment">// 2</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>首先加载 main 方法所在的类 <code>ClinitTest1</code> ；</li>
<li>开始执行 main 方法，遇到调用 <code>Son.B</code> ，开始加载 <code>Son</code> 类，执行 <code>&lt;clinit&gt;</code> ；</li>
<li>由于 <code>Son</code> 类有父类 <code>Father</code> ， <strong>双亲委派机制</strong> ，先执行 <code>Father</code> 的 <code>&lt;clinit&gt;</code> ，加载父类先；</li>
<li>父类的 static 变量经过加载链接初始化之后， <code>A = 2</code> ；</li>
<li>然后执行 <code>Son</code> 的 <code>&lt;clinit&gt;</code> ，得到 <code>B = 2</code> ；</li>
<li>最后输出为 2 ；</li>
<li>虚拟机必须保证一个类的 <code>&lt;clinit&gt;()</code> 方法在多线程下被 <strong>同步加锁</strong> ；</li>
</ol>
<p>第 7 点可以用以下代码验证：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DeadThreadTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Runnable</span> <span class="variable">task</span> <span class="operator">=</span> () -&gt; &#123;</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">&quot;开始&quot;</span>);</span><br><span class="line">            <span class="type">DeadThread</span> <span class="variable">deadThread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DeadThread</span>();</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">&quot;结束&quot;</span>);</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="type">Thread</span> <span class="variable">thread1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(task, <span class="string">&quot;线程1&quot;</span>);</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">thread2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(task, <span class="string">&quot;线程2&quot;</span>);</span><br><span class="line"></span><br><span class="line">        thread1.start();</span><br><span class="line">        thread2.start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DeadThread</span> &#123;</span><br><span class="line">    <span class="comment">// &lt;clint&gt; 方法，将被 jvm 同步加锁</span></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">&quot;初始化 DeadThread&quot;</span>);</span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                <span class="comment">// 其中一个线程会被卡在这里，而另外一个线程由于得不到锁，所以两个线程都无法输出结束</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="类的加载器">类的加载器</h4>
<p>类加载器（ClassLoader）的作用就是用来把类装载进内存的。JVM 规范定义了如下几类加载器：</p>
<ul>
<li>引导类加载器：用 C++ 编写的，是 JVM 自带的类加载器，负责 Java 平台核心库，用来装载核心类库。<strong>无法直接获取。</strong></li>
<li>扩展类加载器：负责 <code>re/lib/ext</code> 目录下的 jar 包或 <code>-D java.ext.dirs</code> 指定目录下的 jar 包装入工作库；</li>
<li>系统类加载器：负责 <code>java-classpath</code> 或 <code>-D java.class.path</code> 所指的目录下的类与 jar 包装入工作，是最常用的加载器；</li>
<li>用户自定义加载器：用户自定义；</li>
</ul>
<p>这里的四种加载器之间的关系不是上下级、不是继承关系，而是包含关系。</p>
<p>这三个类加载器以及自定义加载器的层次结构如下：</p>
<p><img src="../../../../../assets/%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1%E8%AF%AD%E8%A8%80/Java/JVM/%E7%B1%BB%E5%8A%A0%E8%BD%BD%E6%9C%BA%E5%88%B6/1e7913aabfc6dea0b525664d34a72b587b5c86f8dcb4faf8b0c37afa1fd6c636.png" alt="picture 1"></p>
<p>在代码中，类加载器的关系如下（这里只有 <code>ExtClassLoader</code> 和 <code>AppClassLoader</code> 没有 <code>BootstrapClassLoader</code> ，因为引导类加载器是 C/C++ 编写的，不在 java 源码里面）：</p>
<p><img src="../../../../../assets/%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1%E8%AF%AD%E8%A8%80/Java/JVM/%E7%B1%BB%E5%8A%A0%E8%BD%BD%E6%9C%BA%E5%88%B6/efc7af539b9e0a1727f18660b82d54010482ddf1cdf9249f49a833132cc6cf9f.png" alt="picture 3"></p>
<p><code>sun.misc.Launcher</code> 是 JVM 的入口应用， <code>ExtClassLoader</code> 和 <code>AppClassLoader</code> 都是 <code>Launcher</code> 的内部类。</p>
<p>这些类加载器是自上而下加载，自下而上检查是否加载完成的。此外我们还可以自定义类加载器；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取系统类加载器</span></span><br><span class="line"><span class="type">ClassLoader</span> <span class="variable">systemClassLoader</span> <span class="operator">=</span> ClassLoader.getSystemClassLoader();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取系统类加载器的父类加载器--&gt;扩展类加载器</span></span><br><span class="line"><span class="type">ClassLoader</span> <span class="variable">extClassLoader</span> <span class="operator">=</span> systemClassLoader.getParent();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取扩展类加载器的父类加载器--&gt;根加载器（是用C/C++写的）</span></span><br><span class="line"><span class="type">ClassLoader</span> <span class="variable">rootClassLoader</span> <span class="operator">=</span> systemClassLoader.getParent(); <span class="comment">//null，因为无法获取</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 获得系统类加载器可以加载的路径</span></span><br><span class="line">System.getProperty(<span class="string">&quot;java.class.path&quot;</span>);</span><br></pre></td></tr></table></figure>
<h4 id="双亲委派机制">双亲委派机制</h4>
<p>JVM <strong>按需</strong> 加载 class 文件，只有当使用到某个类时才会将 class 文件加载到内存生成类对象。加载时采用的时双亲委派机制，把请求交给父类处理，是一种任务委派模式。</p>
<p><strong>双亲委派机制</strong>：加载 <code>java.lang.String</code> 类时，JVM 会从用户自定义的类加载器开始（如果有）向上到 <code>AppClassLoader</code> 再向上到 <code>ExtClassLoader</code> 直到 <code>BootstrapClassLoader</code> 。一步步将加载任务委派给上一级的类加载器，如果上一级的类加载器能够加载就加载，不能再由下一级类加载器加载，是个递归的操作。这样做也可以保证程序的安全性，比如 java 的核心类库不会被用户自定义的类覆盖，如果没有用双亲委派机制加载，那对于从网络中获取字节码加载的场景，就会有攻击注入的风险。</p>
<p>在双亲委派加载过程中，每个类只会被加载一次，不会被重复加载。而且可以保护系统核心 API ，当加载到自定义的 <code>java.*</code> 或者 <code>javax.*</code> 等包（即试图使用引导类加载器加载用户自定义类），会发生安全异常。这种保护又叫做 <strong>沙箱安全机制</strong>。</p>
<h3 id="其他">其他</h3>
<p>判断 JVM 中两个 Class 对象是否一样：</p>
<ol>
<li>类的全限定名是否一致；</li>
<li>加载类的 classLoader 必须相同；</li>
</ol>
<p>对于用户类加载器加载的类， <strong>JVM 会将类加载器的引用作为类型信息的一部分保存在方法区中</strong> 。当解析一个类型到另一个类型的引用的时候， JVM 需要保证这两个类型的类加载器是相同的。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/06/12/article/%E8%AE%A1%E7%AE%97%E6%9C%BA/%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1%E8%AF%AD%E8%A8%80/Java/JVM/%E7%AE%80%E4%BB%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/06/12/article/%E8%AE%A1%E7%AE%97%E6%9C%BA/%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1%E8%AF%AD%E8%A8%80/Java/JVM/%E7%AE%80%E4%BB%8B/" class="post-title-link" itemprop="url">简介</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-06-12 00:00:00" itemprop="dateCreated datePublished" datetime="2022-06-12T00:00:00+08:00">2022-06-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-02-01 01:54:09" itemprop="dateModified" datetime="2025-02-01T01:54:09+08:00">2025-02-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/article/" itemprop="url" rel="index"><span itemprop="name">article</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/article/%E8%AE%A1%E7%AE%97%E6%9C%BA/" itemprop="url" rel="index"><span itemprop="name">计算机</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/article/%E8%AE%A1%E7%AE%97%E6%9C%BA/%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1%E8%AF%AD%E8%A8%80/" itemprop="url" rel="index"><span itemprop="name">程序设计语言</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/article/%E8%AE%A1%E7%AE%97%E6%9C%BA/%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1%E8%AF%AD%E8%A8%80/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/article/%E8%AE%A1%E7%AE%97%E6%9C%BA/%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1%E8%AF%AD%E8%A8%80/Java/JVM/" itemprop="url" rel="index"><span itemprop="name">JVM</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="简介">简介</h2>
<p>JVM (Java Virtual Machine) Java 虚拟机是物理机与高级语言之间的一层抽象层。用于封装各个硬件平台的不同，让各种高级语言只要面向虚拟机编程，不用了解硬件上的差别。最终“实现一次编写，到处运行”的目的。</p>
<h3 id="Java-技术体系">Java 技术体系</h3>
<p>广义上来讲，用 JVM 运行的 Kotlin 、 Clojure 、 JRuby 、 Groovy 等语言都属于 Java 技术体系。但按照 JCP 官方定义的 Java 技术体系分为：</p>
<ul>
<li>Java 程序设计语言</li>
<li>各个硬件平台上的 Java 虚拟机实现</li>
<li>Class 文件格式</li>
<li>Java 类库 API</li>
<li>来自商业机构和开源社区的第三方 Java 类库</li>
</ul>
<p>JDK （Java Development Kit）是 Java语言、Java 虚拟机、 Java 类库这三部分的统称 ，是支持 Java 程序开发的最小环境。<br>
JRE （Java Runtime  Environemnt）是 Java SE API 子集和 Java 虚拟机这两部分的统称，是支持 Java 程序运行的最标准境。</p>
<p><img src="../../../../../assets/%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1%E8%AF%AD%E8%A8%80/Java/JVM/%E7%AE%80%E4%BB%8B/0a5ca6d1e78d45da31077e5cb7e30cbb5c88d91dff7141432d90f9128133eeec.png" alt="picture 1"></p>
<p>上图是 Java 技术体系的各个组成部分，以及 JDK 和 JRE 所包含的范围。</p>
<p>JDK = JRE + Java 语言 + Java 工具</p>
<p>上述是按照<strong>功能组件</strong>来分的。</p>
<p>从<strong>产品线</strong>来划分， Java 技术体系包括：</p>
<ul>
<li>Java Card ：支持 Java 小程序运行在小内存设备（智能卡）上的平台；</li>
<li>Java ME（Micro Edition）：移动终端（手机、PDA）的运行平台；</li>
<li>Java SE（Standard Edition）：桌面级应用的平台，提供了完整的 Java 核心 API；</li>
<li>Java EE（Enterprise Edition）：支持多层架构的企业级应用，这条产品线在 JDK 10 之后被 Oracle 放弃，捐献给 Eclipse 基金会管理，后称 Jakarta EE；</li>
</ul>
<p>Java EE 针对 SE 做了很多针对性的补充，这些补充包一般以 <code>javax.*</code> 开头，后来一部分这些包被加入到 <code>java.*</code> 的核心包中。</p>
<h3 id="JVM-家族">JVM 家族</h3>
<ul>
<li>Sun Classic/Exact VM：
<ul>
<li>Classic 是 Java 的第一个虚拟机，只能用纯解释的方式来运行 Java 代码，如果需要即时编译器（用于将字节码编译成本机能立刻执行的机器码），则即时编译器会完全接管虚拟机的执行系统，即解释和编译只能二选一。如果外挂即时编译器，那么不管代码是否有编译价值，都会被编译，但是基于程序响应时间的压力，编译器不敢使用耗时高的优化技术，导致编译后的机器码执行效率不如 C/C++ ，解释执行就更不用说了，所以这时的 Java 代码执行很慢；</li>
<li>Exact VM　由于使用了准确式内存管理（Exact Memory Management）而得名。准确式内存管理就是能准确地知道内存某个位置的数据具体是值类型还是引用类型，这可以在垃圾收集阶段判断堆上数据是否还可能被使用。Exact VM 还抛弃了 Classic VM 的基于句柄（广义指针）的对象查找方式，节省了一次间接查找的时间；</li>
</ul>
</li>
<li>Hotspot VM：Hotspot VM 继承了 Exact VM 的准确式内存管理，并提供了热点代码探测技术，如果一段代码被频繁调用，将会分别触发标准即时编译器和栈上替换编译（On-Stack Replacement，OSR）行为；</li>
<li>Mobile/Embedded VM：这个虚拟机是面向移动端和嵌入式时常的，在现在面临 Android 和 IOS 平分天下的格局，这类虚拟机只在性能很有限的功能机上使用了；</li>
<li>BEA JRockit/IBM J9 VM
<ul>
<li>BEA JRockit：曾经是号称世界上最快的 JVM ，最开始主要面向服务器端，所以不在意程序的启动速度，所以没有解释器，完全由即时编译器构成，现已不再发展；</li>
<li>IBM J9 VM：市场定位与 Hotspot 相近，模块化比 Hotspot 做的更优秀，核心组件库（垃圾收集器、即时编译器、诊断监控子系统等）都单独构成了 IBM OMR 项目，可以在其他语言平台快速组装出相应的功能；</li>
</ul>
</li>
<li>BEA Liquid VM/Azul VM：与特定硬件平台绑定、软硬件配合工作的专有虚拟机，具有更高的执行性能；</li>
<li>Apache Harmony/Google Android Dalvik VM：Harmony VM 没有被商用过，代码被吸纳进 Dalvik VM 中，Dalvik VM 后来被 ART 虚拟机取代；</li>
<li>其他。。。</li>
</ul>
<h3 id="无语言倾向的虚拟机-Graal-VM">无语言倾向的虚拟机 Graal VM</h3>
<p>Graal VM 的基本工作原理是将语言的源代码或者源代码编译后的中间格式，通过解释器转换成 Graal VM 可读的中间格式。例如对于 LLVM 语言 C/C++ 专门设计一个解释器来满足输出字节码的转换，这个过程被称为程序特化（Specialized）。这种虚拟机可以把本来运行速度不快的平台，比如 python 和 javascript 通过运行时的自动优化以达到更高的执行效率，并且无论什么语言，无论什么平台都能够在上面运行。</p>
<h3 id="新一代的即时编译器-Graal-编译器">新一代的即时编译器 Graal 编译器</h3>
<p>自 JDK 10 起，Hotspot VM 替换了 原有的 C2 编译器，改用 Graal 编译器。这个新编译器能够比旧编译器执行更复杂的优化，比如 部分逃逸分析（Partial Escape Analysis），也比 C2 更容易进行激进预测性优化（Aggressive Speculative Optimization），支持自定义的预测性假设；实现时，可以采用了和 C2 编译器相同的名为 Sea-of-nodes 的高级中间表示形式，更容易继承 C2 的优点。总的来说前途可期。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/06/06/article/%E8%AE%A1%E7%AE%97%E6%9C%BA/%E5%B7%A5%E5%85%B7/git/git%20ssh%20%E5%8D%8F%E8%AE%AE%E5%87%BA%E7%8E%B0%2022%20%E7%AB%AF%E5%8F%A3%E6%8B%92%E7%BB%9D%E8%BF%9E%E6%8E%A5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/06/06/article/%E8%AE%A1%E7%AE%97%E6%9C%BA/%E5%B7%A5%E5%85%B7/git/git%20ssh%20%E5%8D%8F%E8%AE%AE%E5%87%BA%E7%8E%B0%2022%20%E7%AB%AF%E5%8F%A3%E6%8B%92%E7%BB%9D%E8%BF%9E%E6%8E%A5/" class="post-title-link" itemprop="url">git ssh 协议出现 22 端口拒绝连接</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-06-06 00:00:00" itemprop="dateCreated datePublished" datetime="2022-06-06T00:00:00+08:00">2022-06-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-02-01 01:54:09" itemprop="dateModified" datetime="2025-02-01T01:54:09+08:00">2025-02-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/article/" itemprop="url" rel="index"><span itemprop="name">article</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/article/%E8%AE%A1%E7%AE%97%E6%9C%BA/" itemprop="url" rel="index"><span itemprop="name">计算机</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/article/%E8%AE%A1%E7%AE%97%E6%9C%BA/%E5%B7%A5%E5%85%B7/" itemprop="url" rel="index"><span itemprop="name">工具</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/article/%E8%AE%A1%E7%AE%97%E6%9C%BA/%E5%B7%A5%E5%85%B7/git/" itemprop="url" rel="index"><span itemprop="name">git</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="git-ssh-协议出现-22-端口拒绝连接">git ssh 协议出现 22 端口拒绝连接</h2>
<h3 id="出现问题">出现问题</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt; git push</span><br><span class="line">ssh: connect to host github.com port 22: Connection refused</span><br><span class="line">fatal: Could not <span class="built_in">read</span> from remote repository.</span><br><span class="line"></span><br><span class="line">Please make sure you have the correct access rights</span><br><span class="line">and the repository exists.</span><br></pre></td></tr></table></figure>
<h3 id="问题分析及解决">问题分析及解决</h3>
<p>通过 <code>ssh</code> 命令直接访问 <code>git@github.com</code> 检查连通性；</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt; ssh -vT git@github.com</span><br><span class="line"></span><br><span class="line">OpenSSH_for_Windows_8.1p1, LibreSSL 3.0.2</span><br><span class="line">debug1: Connecting to github.com [127.0.0.1] port 22.</span><br><span class="line">debug1: connect to address 127.0.0.1 port 22: Connection refused</span><br><span class="line">ssh: connect to host github.com port 22: Connection refused</span><br></pre></td></tr></table></figure>
<p>发现 <code>github.com</code> 被映射到 <code>127.0.0.1</code> 了，猜测是开启了科学上网导致的，顺势给 git 配置代理，以提升推拉代码速度；</p>
<p>在 <code>C:\User\Administrator\.ssh</code> 目录下建立 <code>config</code> 文件，输入如下内容：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 代理的地址按照自己的工具来配置，这里是 127.0.0.1:10808</span></span><br><span class="line">ProxyCommand connect -S 127.0.0.1:10808 -a none %h %p</span><br><span class="line"></span><br><span class="line">Host github.com</span><br><span class="line">        User doge-liang</span><br><span class="line">        Port 22</span><br><span class="line">        Hostname github.com</span><br><span class="line">        <span class="comment"># 路径使用自己的 ssh private key</span></span><br><span class="line">        IdentityFile <span class="string">&quot;C:\Users\Administrator\.ssh\id_rsa&quot;</span></span><br><span class="line">        TCPKeepAlive <span class="built_in">yes</span></span><br></pre></td></tr></table></figure>
<p>保存后即可连通；</p>
<h3 id="类似问题">类似问题</h3>
<p>科学上网之后，使用 https 的方式推送代码也无法推送，猜测是同样的原因导致的。 https 的代理设置和 ssh 不同；<br>
只要设置 <code>git config</code> 即可</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">git config --global http.proxy http://127.0.0.1:10809</span><br><span class="line">git config --global https.proxy http://127.0.0.1:10809</span><br><span class="line"></span><br><span class="line"><span class="comment"># 取消设置</span></span><br><span class="line">git config --global --<span class="built_in">unset</span> http.proxy</span><br><span class="line">git config --global --<span class="built_in">unset</span> https.proxy</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/06/05/article/%E8%AE%A1%E7%AE%97%E6%9C%BA/%E5%AE%89%E5%85%A8/%E5%B8%B8%E8%A7%81%E6%94%BB%E5%87%BB/CSRF/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/06/05/article/%E8%AE%A1%E7%AE%97%E6%9C%BA/%E5%AE%89%E5%85%A8/%E5%B8%B8%E8%A7%81%E6%94%BB%E5%87%BB/CSRF/" class="post-title-link" itemprop="url">CSRF</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-06-05 00:00:00" itemprop="dateCreated datePublished" datetime="2022-06-05T00:00:00+08:00">2022-06-05</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-02-01 01:22:05" itemprop="dateModified" datetime="2025-02-01T01:22:05+08:00">2025-02-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/article/" itemprop="url" rel="index"><span itemprop="name">article</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/article/%E8%AE%A1%E7%AE%97%E6%9C%BA/" itemprop="url" rel="index"><span itemprop="name">计算机</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/article/%E8%AE%A1%E7%AE%97%E6%9C%BA/%E5%AE%89%E5%85%A8/" itemprop="url" rel="index"><span itemprop="name">安全</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/article/%E8%AE%A1%E7%AE%97%E6%9C%BA/%E5%AE%89%E5%85%A8/%E5%B8%B8%E8%A7%81%E6%94%BB%E5%87%BB/" itemprop="url" rel="index"><span itemprop="name">常见攻击</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="CSRF">CSRF</h2>
<p>跨站请求伪造 Cross-site request forgery ，也被称为 one-click attack 或者 session riding 通常缩写为 CSRF 或者 XSRF。</p>
<h3 id="攻击原理">攻击原理</h3>
<p><img src="../../../../assets/%E5%AE%89%E5%85%A8/%E5%B8%B8%E8%A7%81%E6%94%BB%E5%87%BB/CSRF/e5392f3403aa751c5a87b8b86a1d833a4edbc32b7d8b8bd12e78cdb6f335ed51.png" alt="picture 1"></p>
<p>从上述攻击原理图可以看出， CSRF 攻击的原因在于网站 A （受攻击网站）单凭 Cookie 无法得知用户的浏览器是否可信任。</p>
<h3 id="防御策略">防御策略</h3>
<ol>
<li>验证 HTTP Referer 字段；</li>
<li>在受限请求地址中添加 token 并验证；</li>
<li>在 HTTP 头中自定义属性并验证；</li>
</ol>
<h4 id="HTTP-Referer-字段">HTTP Referer 字段</h4>
<p>在 HTTP 协议中，有一个请求头字段叫 Referer 这个字段记录了该 HTTP 请求的来源地址（比如在 <a target="_blank" rel="noopener" href="http://www.google.com">www.google.com</a> 中点击超链接到 <a target="_blank" rel="noopener" href="http://www.baidu.com">www.baidu.com</a> ，那么发送到 baidu 服务器的请求中 Referer 中就是 <a target="_blank" rel="noopener" href="http://www.google.com">www.google.com</a> ），服务器可以校验该字段是否为自己域名下的，来判断该请求的来源是否合法；</p>
<ul>
<li>优点：对于网站开发人员来说，简单易操作，只要给所有的接口添加一个统一的拦截器，校验 Referer 字段是否为当前域名的即可；</li>
<li>缺点：
<ul>
<li>该安全策略依赖于浏览器对于 HTTP 协议的实现，有些浏览器（IE 6、FF2）存在安全漏洞，会被篡改 Referer 的值，导致网站误认请求来自于自己域名下而被攻击；</li>
<li>对于 Open API 这种防护策略显然会影响业务的正常运行，比如开放的支付接口就是需要经过别的网站发起的调用的；</li>
</ul>
</li>
</ul>
<h4 id="token-验证">token 验证</h4>
<p>由于 CSRF 发生原理是由于攻击者可以在用户的浏览器端伪造请求欺骗受害网站，所以我们可以验证浏览器的请求中是否有 token 来判断请求是否伪造的。这个 token 不能放在 Cookie 中，需要在用户登录的是否随机生成，放在服务器的 session 中，并在每次请求中以参数的形式返回给用户，并隐藏起来。</p>
<ul>
<li>优点：比 Referer 更加安全；</li>
<li>缺点：
<ul>
<li>需要给每个接口都添加 token 参数，前端实现繁琐，容易有漏网之鱼；</li>
<li>对于支持用户自己发布内容的系统，比如论坛、博客网站等，黑客可以在发布内容中写上自己的网站链接，如果网站没有判断该连接是否为外链，就当作是自己系统的链接给他加上了 CSRF token 那么当网站用户点击该地址，黑客网站拿到用户的 token 便马上可以发起 CSRF 攻击；</li>
<li>即使 token 没有以请求的方式添加在链接中，黑客也可能通过 Referer 中获取到 token；</li>
</ul>
</li>
</ul>
<h4 id="请求头验证">请求头验证</h4>
<p>该方法也是使用 token 防止黑客篡改，只不过 token 不是在参数中传输，而是在请求头中传输；</p>
<ul>
<li>优点：
<ul>
<li>token 不会被记录到地址栏中；</li>
<li>token 不会在 Referer 中泄露；</li>
<li>前端实现比上一种方式的实现简单，可以通过 XMLHttpRequest 一次性给所有的请求都加上请求头 token ；</li>
</ul>
</li>
<li>缺点：
<ul>
<li>请求页面不会被浏览器记录，从而前进、后退、刷新、收藏等操作无效；</li>
<li>对于没有 CSRF 防护的网站来说，请求方式需要全部替换成 XMLHttpRequest 请求，成本高；</li>
</ul>
</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="Previous page" aria-label="Previous page" href="/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/21/">21</a><a class="extend next" rel="next" title="Next page" aria-label="Next page" href="/page/3/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">John Doe</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdn.bootcdn.net/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  

  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"https://cdn.bootcdn.net/ajax/libs/mermaid/11.4.0/mermaid.min.js","integrity":"sha256-G8ouPAnw4zzMbnAenHnVz6h9XpKbNdOkrqTh7AadyHs="}}</script>
  <script src="/js/third-party/tags/mermaid.js"></script>





  





</body>
</html>
